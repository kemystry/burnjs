(function(){var AddClassBinder,BgImageBinder,Burn,EachBinder,IncludeComponent,RhrefBinder,ViewBinder,extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty,bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Burn=function(){function Burn(){}return Burn.adapters={},Burn.controllers={},Burn.models={},Burn.collections={},Burn.views={},Burn.currentController=null,Burn.resourceHost="",Burn.resourceAttrTransform=null,Burn.registerController=function(controller){var name,ref,results,route,routePath;this.router||(this.router=new Burn.Router),this.controllers[controller.name]=controller,ref=controller.prototype.routes,results=[];for(route in ref)name=ref[route],controller.prototype.scope?routePath=controller.prototype.scope+"/"+route+"(/)":(routePath=route+"(/)","*path"===route&&(routePath=route)),results.push(Burn.router.registerRoute(routePath,name,controller));return results},Burn.registerView=function(view){return this.views[view.name]=view},Burn.registerModel=function(model){return this.models[model.name]=model},Burn.registerCollection=function(collection){return this.collections[collection.name]=collection},Burn.registerBinder=function(name,binder){return rivets.binders[name]=binder},Burn.registerFormatter=function(name,formatter){return rivets.formatters[name]=formatter},Burn.registerComponent=function(name,component){return rivets.components[name]=component},Burn.layout=function(layout){return _.isString(layout)?(this.currentLayout=new Burn.Layout,this.currentLayout.template=layout):layout instanceof Burn.Layout&&(this.currentLayout=layout),this.currentLayout.render(),this.currentLayout},Burn.start=function(opts){return this._initOpts(opts),this._initConfig(),this._initAdapters(),Backbone.history.start()},Burn._initOpts=function(opts){return this.opts=opts||{},this.resourceHost=this.opts.resourceHost||"",this.resourceAttrTransform=this.opts.resourceAttrTransform||null},Burn._initAdapters=function(){return rivets.adapters[":"]=Burn.adapters.BackboneRelational()},Burn._initConfig=function(){var config;return config={prefix:"brn",preloadData:!0,rootInterface:".",templateDelimiters:["{","}"],handler:function(target,event,binding){return binding.model instanceof Burn.Model?this.call(binding.model):this.call(target,event,binding.view.models)}},rivets.configure(config)},Burn}(),self.Burn=Burn,Burn.Cache=function(){function Cache(namespace,persist){this.persist=persist||!1,this.namespace=namespace||""}return Cache.prototype.cache={},Cache.prototype.persist=!1,Cache.prototype.namespace="",Cache.prototype.set=function(key,val){return this.persist?self.localStorage.setItem(this.namespace+":"+key,val):this.cache[key]=val},Cache.prototype.get=function(key){return this.persist?self.localStorage.getItem(this.namespace+":"+key):this.cache[key]},Cache.prototype.remove=function(key){return this.persist?self.localStorage.removeItem(this.namespace+":"+key):delete this.cache[key]},Cache.prototype.clear=function(){var key,ref,results,val;if(this.persist){ref=self.localStorage,results=[];for(key in ref)val=ref[key],0===key.indexOf(this.namespace+":")?results.push(self.localStorage.removeItem(key)):results.push(void 0);return results}return this.cache=[]},Cache}(),Burn.adapters.BackboneRelational=function(){var _factory,_getter,_setter;return _factory=function(action){return function(model,keypath,callback){var eventName,value;if(model instanceof Backbone.RelationalModel){if(value=model.get(keypath),eventName="*"===keypath?"change":"change:"+keypath,model[action](eventName,callback),value instanceof Backbone.Collection)return value[action]("add remove reset sort change",callback)}else if(model instanceof Backbone.Collection&&"models"===keypath)return model[action]("add remove reset sort change",callback)}},_getter=function(obj,keypath){var value;return obj instanceof Backbone.RelationalModel?(value="*"===keypath?obj.attributes:obj.get(keypath),value instanceof Backbone.Collection&&(value=value.models)):obj instanceof Backbone.Collection&&(value=obj.models),value},_setter=function(obj,keypath,value){return obj instanceof Backbone.RelationalModel||obj instanceof Backbone.Collection?"*"===keypath?obj.set(value):obj.set(keypath,value):void 0},{observe:_factory("on"),unobserve:_factory("off"),get:_getter,set:_setter}},Burn.Router=function(superClass){function Router(){return Router.__super__.constructor.apply(this,arguments)}return extend(Router,superClass),Router.prototype.registerRoute=function(path,name,controller){var callback;return callback=function(){var arg,ctrl,i,len,match,params,re;if(Burn.currentController instanceof controller?ctrl=Burn.currentController:(Burn.currentController&&Burn.currentController.destroy(),ctrl=Burn.currentController=new controller),console.log("TODO: Add layout attr to controllers,\nonly re-layout when needed"),params={},arguments.length>0)for(re=/:([a-zA-Z0-9_\-]+)/g,i=0,len=arguments.length;len>i;i++)arg=arguments[i],_.isNull(arg)||(match=re.exec(path),match&&match[1]?params[match[1]]=arg:params.query=_.chain(arg.split("&")).map(function(params){var p;return p=params.split("="),[p[0],decodeURIComponent(p[1])]}).object().value());return ctrl.runBeforeFilters.apply(ctrl,[params,path,name]).done(function(){return ctrl[name].apply(ctrl,[params]),ctrl.runAfterFilters.apply(ctrl,[params,path,name])}).fail(function(message){return ctrl.onFilterFail(message,params,path,name)})},this.route(path,name,callback)},Router}(Backbone.Router),Burn.FilterChain=function(){function FilterChain(filters,path,name){this._runFilter=bind(this._runFilter,this),this._fail=bind(this._fail,this),this._next=bind(this._next,this),this._path=path,this._name=name,this.filters=filters}return FilterChain.prototype.filters=[],FilterChain.prototype.start=function(){return this.q=$.Deferred(),this._next(),this.q.promise()},FilterChain.prototype._next=function(){return this._runFilter(this.filters.shift())},FilterChain.prototype._fail=function(message){return this.q.reject(message)},FilterChain.prototype._runFilter=function(filter){return _.isUndefined(filter)?this.q.resolve():filter.apply(this,[this._next,this._fail,this._path,this._name])},FilterChain}(),Burn.Controller=function(){function Controller(){}return Controller.prototype.layout=null,Controller.prototype.routes={},Controller.prototype.beforeFilters={},Controller.prototype.afterFilters={},Controller.prototype._events=[],Controller.prototype.listenTo=function(obj,event,callback){return this._events.push([obj,event,callback]),obj.on(event,callback)},Controller.prototype.stopListening=function(obj){var evt,i,idx,j,len,len1,ref,ref1,results;if(_.isUndefined(obj)){for(ref=this._events,idx=i=0,len=ref.length;len>i;idx=++i)evt=ref[idx],evt[0].off(evt[1],evt[2]);return this._events=[]}for(ref1=this._events,results=[],idx=j=0,len1=ref1.length;len1>j;idx=++j)evt=ref1[idx],evt[0]===obj?(evt[0].off(evt[1],evt[2]),results.push(this._events.splice(idx,1))):results.push(void 0);return results},Controller.prototype.runBeforeFilters=function(params,path,name){var filters;return filters=this._buildFilterChain(name,this._getFilters("beforeFilters")),new Burn.FilterChain(filters,path,name).start()},Controller.prototype.runAfterFilters=function(params,path,name){var filters;return filters=this._buildFilterChain(name,this._getFilters("afterFilters")),new Burn.FilterChain(filters,path,name).start()},Controller.prototype.destroy=function(){return this.beforeDestroy(),this.stopListening(),this.afterDestroy()},Controller.prototype.beforeDestroy=function(){},Controller.prototype.afterDestroy=function(){},Controller.prototype.onFilterFail=function(){},Controller.prototype._getFilters=function(filterKey){var filters;return filters={},this.constructor.__super__&&this.constructor.__super__[filterKey]&&(filters=this.constructor.__super__._getFilters(filterKey)),_.extend(filters,this[filterKey])},Controller.prototype._buildFilterChain=function(name,filters){var action,chain,opts,run;chain=[],console.log("TODO: Change from object to Array to make sure they run in order");for(action in filters)opts=filters[action],run=!1,"all"===opts?run=!0:opts.only&&-1!==opts.only.indexOf(name)?run=!0:opts.except&&-1===opts.except.indexOf(name)&&(run=!0),run&&chain.push(this[action]);return chain},Controller}(),Burn.Model=function(superClass){function Model(){this.validations=new Backbone.RelationalModel,this.on("validated:invalid",function(_this){return function(model,errors){return _this.validations.clear(),_this.validations.set(errors)}}(this)),this.on("validated:valid",function(_this){return function(model,errors){return _this.validations.clear()}}(this)),this.on("request",function(){return this.updating=!0}),this.on("sync",function(){return this.updating=!1}),this.on("error",function(){return this.updating=!1}),this.on("change",function(model,options){var i,key,len,ref,results;for(ref=_.keys(model.changed),results=[],i=0,len=ref.length;len>i;i++)key=ref[i],results.push(model.validate(key));return results}),Model.__super__.constructor.apply(this,arguments)}return extend(Model,superClass),Model.prototype.fetching=!1,Model.prototype.destroying=!1,Model.prototype.updating=!1,Model.prototype.saving=!1,Model.prototype.url=function(){var _url,id,path;if(!this.resourcePath)throw new Error(this.constructor.name+" must specify a resourcePath");return path=_.isFunction(this.resourcePath)?this.resourcePath():this.resourcePath,id=this.get("id"),_url=Burn.resourceHost+"/"+path,id&&(_url=_url+"/"+id),_url+"/"},Model.prototype.update=function(opts){return opts=opts||{},this.changedAttributes()&&(opts.patch=!0),this.save(_.pick(this.toJSON(),_.keys(this.changed)),opts)},Model.prototype.toJSON=function(opts){var attributes;return attributes=Model.__super__.toJSON.call(this,opts),this.excludeFromJSON&&(attributes=_.omit(attributes,this.excludeFromJSON)),attributes},Model.prototype.validateField=function(field){var val;return val=this.preValidate(field,this.get(field)),val?this.validations.set(field,val):this.validations.unset(field)},Model.prototype.fetch=function(){return this.fetching=!0,this._xhr&&(4!==this._xhr.readyState&&this._xhr.abort(),this._xhr=null),this._xhr=Model.__super__.fetch.apply(this,arguments),this._xhr.done(function(_this){return function(){return _this.fetching=!1}}(this)),this._xhr.fail(function(_this){return function(){return _this.fetching=!1}}(this)),this._xhr},Model.prototype.save=function(){return this._xhr=Model.__super__.save.apply(this,arguments),this._xhr?(this.saving=!0,this._xhr.done(function(_this){return function(){return _this.saving=!1}}(this)),this._xhr.fail(function(_this){return function(){return _this.saving=!1}}(this)),this._xhr):this._xhr},Model.prototype.destroy=function(){return this._xhr=Model.__super__.destroy.apply(this,arguments),this._xhr?(this.destroying=!0,this._xhr.done(function(_this){return function(){return _this.destroying=!1}}(this)),this._xhr.fail(function(_this){return function(){return _this.destroying=!1}}(this)),this._xhr):this._xhr},Model}(Backbone.RelationalModel),_.extend(Burn.Model.prototype,Backbone.Validation.mixin),Burn.Collection=function(superClass){function Collection(){this.on("request",function(collection){return collection===this?this.updating=!0:void 0}),this.on("sync",function(collection){return collection===this?this.updating=!1:void 0}),this.on("error",function(collection){return collection===this?this.updating=!1:void 0}),Collection.__super__.constructor.apply(this,arguments)}return extend(Collection,superClass),Collection.prototype.updating=!1,Collection.prototype.fetching=!1,Collection.prototype.url=function(){var path;if(!this.resourcePath)throw new Error(this.constructor.name+" must specify a resourcePath");return path=_.isFunction(this.resourcePath)?this.resourcePath():this.resourcePath,Burn.resourceHost+"/"+path+"/"},Collection.prototype.fetch=function(){return this.fetching=!0,this._xhr&&(4!==this._xhr.readyState&&this._xhr.abort(),this._xhr=null),this._xhr=Collection.__super__.fetch.apply(this,arguments),this._xhr.done(function(_this){return function(){return _this.fetching=!1}}(this)),this._xhr.fail(function(_this){return function(){return _this.fetching=!1}}(this)),this._xhr},Collection}(Backbone.Collection),Burn.Template=function(){function Template(templateUrl){this.load=bind(this.load,this),this.templateUrl=templateUrl+"?rev="+Burn.Template.revision}return Template.revision="",Template.caching=!0,Template.store={},Template.baseUrl="",Template.prototype.templateUrl="",Template.prototype.templateString="",Template.prototype.load=function(cache){var q;return _.isUndefined(cache)&&(cache=Burn.Template.caching),cache&&Burn.Template.store[this.templateUrl]||(q=$.Deferred(),$.get(this.templateUrl).done(function(_this){return function(tpl){return _this.templateString=tpl,q.resolve(_this.templateString)}}(this)).fail(function(){return q.reject()}),Burn.Template.store[this.templateUrl]=q.promise()),Burn.Template.store[this.templateUrl]},Template}(),Burn.Attachment=function(){function Attachment(element){this.subviews=[],this.el=element,this.$el=$(this.el)}return Attachment.prototype.el=null,Attachment.prototype.$el=null,Attachment.prototype.subviews=[],Attachment.prototype.setView=function(view){return this.removeViews(),view.render(),this.$el.html(view.el),this.subviews.push(view)},Attachment.prototype.appendView=function(view){return view.render(),this.$el.append(view.el),this.subviews.push(view)},Attachment.prototype.prependView=function(view){return view.render(),this.$el.append(view.el),this.subviews.push(view)},Attachment.prototype.removeView=function(view){return this.subviews.splice(this.subviews.indexOf(view),1),view.destroy()},Attachment.prototype.destroy=function(){return this.removeViews(),this.$el.remove()},Attachment.prototype.removeViews=function(){var i,len,ref,results,view;for(ref=this.subviews,results=[],i=0,len=ref.length;len>i;i++)view=ref[i],results.push(this.removeView(view));return results},Attachment}(),Burn.Layout=function(){function Layout(opts){var el;opts=opts||{},opts.template&&(this.template=new Burn.Template(opts.template)),el=opts.el||"<div></div>",this.$el=$(el),this.el=this.$el[0],this.initialize(opts)}return Layout.prototype.template=null,Layout.prototype.attachments={},Layout.prototype.el=null,Layout.prototype.$el=null,Layout.prototype.initialize=function(opts){},Layout.prototype.render=function(data){var q;return q=$.Deferred(),this.template.load().done(function(_this){return function(tpl){return _this.$el.html(tpl),_this._initAttachments(),_this._binding=rivets.bind(_this.el,data||{}),q.resolve(_this)}}(this)).fail(function(){return q.reject()}),q.promise()},Layout.prototype.isRendered=function(){return this._binding?!0:!1},Layout.prototype.destroy=function(){var container,name,ref;this._binding&&(this._binding.unbind(),delete this._binding),ref=this.attachments;for(name in ref)container=ref[name],container.destroy(),delete this.attachments[name],delete this[name];return this.$el.remove()},Layout.prototype._initAttachments=function(){return this.$el.find("[brn-attach]").each(function(_this){return function(idx,ele){var $ele,name;return $ele=$(ele),name=$ele.attr("brn-attach"),_this.attachments[name]=new Burn.Attachment(ele),_this[name]=_this.attachments[name]}}(this))},Layout}(),Burn.View=function(superClass){function View(opts){var key,ref,val;if(this.options=opts,_.isObject(opts)&&opts.properties){ref=opts.properties;for(key in ref)val=ref[key],this[key]=val}View.__super__.constructor.apply(this,arguments),this.el.view=this}return extend(View,superClass),View.prototype._binding=null,View.prototype.beforeRender=function(){},View.prototype.afterRender=function(){},View.prototype.beforeDestroy=function(){},View.prototype.afterDestroy=function(){},View.prototype.beforeBind=function(){},View.prototype.afterBind=function(){},View.prototype.beforeTemplateLoad=function(){},View.prototype.afterTemplateLoad=function(){},View.prototype.transformTemplate=function(tpl){return tpl},View.prototype.render=function(){return this.beforeRender(),this.template&&new Burn.Template(this.template).load().then(function(_this){return function(tpl){return _this.beforeTemplateLoad(),tpl=_this.transformTemplate(tpl),_this.$el.html(tpl),_this.afterTemplateLoad(),_this.$el.addClass(_this.constructor.name),_this.beforeBind(),_this._binding=rivets.bind(_this.el,_this),_this.afterBind(),_this.afterRender()}}(this)),this.el},View.prototype.destroy=function(){return this.beforeDestroy(),this.parent=null,this._binding&&(this._binding.unbind(),delete this._binding),this.remove(),this.afterDestroy()},View.prototype.navigate=function(route,trigger){var opts;return trigger!==!1&&(opts={trigger:!0}),Burn.router.navigate(route,opts)},View}(Backbone.View),AddClassBinder=function(el,value){return $(el).hasClass(value)?void 0:$(el).addClass(value)},Burn.registerBinder("add-class",AddClassBinder),BgImageBinder=function(el,value){return null==value&&(value=""),value=value.replace("'","%27"),$(el).css("background-image","url('"+value+"')")},Burn.registerBinder("bg-img",BgImageBinder),EachBinder={block:!0,priority:4e3,bind:function(el){var attr,i,len,ref,view;if(null==this.marker)attr=[this.view.prefix,this.type].join("-").replace("--","-"),this.marker=document.createComment(" rivets: "+this.type+" "),this.iterated=[],el.removeAttribute(attr),el.parentNode.insertBefore(this.marker,el),el.parentNode.removeChild(el);else for(ref=this.iterated,i=0,len=ref.length;len>i;i++)view=ref[i],view.bind()},unbind:function(el){var i,len,ref,view;if(null!=this.iterated)for(ref=this.iterated,i=0,len=ref.length;len>i;i++)view=ref[i],view.unbind()},routine:function(el,collection){var binding,data,i,index,j,key,len,len1,model,modelName,nodes,options,previous,ref,ref1,ref2,template,view;if(modelName=this.args[0],collection||(collection=[]),this.iterated.length>collection.length)for(index=0;index<this.iterated.length;)collection.indexOf(this.iterated[index].models[modelName])>-1?index++:(view=this.iterated.splice(index,1)[0],view.unbind(),$(view.els).remove());else if(this.iterated.length<collection.length)for(index=0;index<collection.length;){if(model=collection[index],this.iterated[index]&&this.iterated[index].models[modelName]!==model){data={index:index},data["%"+modelName+"%"]=index,null==data[modelName]&&(data[modelName]=model),template=el.cloneNode(!0),options=this.view.options(),options.preloadData=!0,ref=this.view.models;for(key in ref)model=ref[key],data[key]=model;view=rivets.bind(template,data,options),this.iterated.splice(index,0,view),nodes=$(this.marker).parent().find("> "+el.nodeName),nodes.eq(index).before(template)}index++}for(index=i=0,len=collection.length;len>i;index=++i)if(model=collection[index],data={index:index},data["%"+modelName+"%"]=index,null==data[modelName]&&(data[modelName]=model),null==this.iterated[index]){ref1=this.view.models;for(key in ref1)model=ref1[key],data[key]=model;previous=this.iterated.length?this.iterated[this.iterated.length-1].els[0]:this.marker,options=this.view.options(),options.preloadData=!0,template=el.cloneNode(!0),view=rivets.bind(template,data,options),this.iterated.push(view),this.marker.parentNode.insertBefore(template,previous.nextSibling)}if("OPTION"===el.nodeName)for(ref2=this.view.bindings,j=0,len1=ref2.length;len1>j;j++)binding=ref2[j],binding.el===this.marker.parentNode&&"value"===binding.type&&binding.sync()},update:function(models){var data,i,key,len,model,ref,view;data={};for(key in models)model=models[key],key!==this.args[0]&&(data[key]=model);for(ref=this.iterated,i=0,len=ref.length;len>i;i++)view=ref[i],view.update(data)}},Burn.registerBinder("each-*",EachBinder),RhrefBinder={bind:function(ele){return $(ele).on("click",function(event){return event.target===event.currentTarget?(event.preventDefault(),Burn.router.navigate($(this).attr("rhref"),{trigger:!0})):void 0})},unbind:function(ele){return $(ele).off("click")},routine:function(ele,value){return value||(value=this.keypath),$(ele).attr("rhref",value.replace(/^\//,"")),$(ele).attr("href","#"+value.replace(/^\//,""))}},Burn.registerBinder("rhref",RhrefBinder),ViewBinder={block:!1,priority:9e3,bind:function(el){var attr,i,len,model,parseAttr,props,ref,val,view;for(parseAttr=function(model,keypath){var v;return v=rivets._.sightglass(model,keypath,null,{root:rivets.rootInterface,adapters:rivets.adapters}),rivets.adapters[":"].get(v.target,v.key.path)},props={},el.removeAttribute("brn-view"),ref=el.attributes,i=0,len=ref.length;len>i;i++)attr=ref[i],attr.value.indexOf(":")>-1&&0!==attr.value.indexOf("!")?model=parseAttr(this.view.models,attr.value):"view"!==attr.name&&(attr.name.indexOf("brn-")>-1||(model=this.view.models[attr.value])),model?props[S(attr.name).camelize().s]=model:(val=0===attr.value.indexOf("!")?attr.value.substr(1):attr.value,props[S(attr.name).camelize().s]=val);return view=$(el).attr("view"),this._view=new Burn.views[view]({el:el,properties:props}),this._view.render()},unbind:function(el){return this._view.destroy()},routine:function(el){}},Burn.registerBinder("view",ViewBinder),Burn.registerFormatter("formatDate",function(target,val){var shortcuts;return shortcuts={"long":"MMM Do, YYYY","short":"MM/DD/YY","datetime-long":"MMM Do, YYYY @ h:mm a","datetime-short":"MM/DD/YYYY @ h:mm a"},shortcuts[val]&&(val=shortcuts[val]),target?moment(target).format(val):target}),Burn.registerFormatter("numeral",function(target,val){return _.isNaN(parseFloat(target))?target:numeral(target).format(val)}),Burn.registerFormatter("currency",function(target,val){return rivets.formatters.numeral(target,"$0,0.00")}),Burn.registerFormatter("formatNumber",function(target,val){return rivets.formatters.numeral(target,"0,0.00")}),Burn.registerFormatter("append",function(target,val){return target?""+target+val:target}),Burn.registerFormatter("prepend",function(target,val){return target?""+val+target:target}),Burn.registerFormatter("shorten",function(target,val,ellipsis){var s;return null==ellipsis&&(ellipsis=!1),_.isUndefinedOrNull(target)||target&&target.length<=val?target:(ellipsis&&(val-=3),s=target.substring(0,val),ellipsis&&(s+="..."),s)}),Burn.registerFormatter("to-string",function(target){return _.isUndefinedOrNull(target)?"":target.toString()}),Burn.registerFormatter("eq",function(target,val){return target===val}),IncludeComponent={"static":["view","tag"],template:function(){return""},initialize:function(el,data){var $el,newEl,opts;return delete data.view,opts={properties:data},this["static"].tag&&($el=$(el),newEl=$("<"+this["static"].tag+"/>"),$el.replaceWith(newEl),el=newEl[0],opts.el=el),this._view=new Burn.views[this["static"].view](opts),$(el).html(this._view.render()),this._view}},Burn.registerComponent("include",IncludeComponent)}).call(this);