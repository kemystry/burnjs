(function(){var Burn,IncludeComponent,extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty,bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Burn=function(){function Burn(){}return Burn.adapters={},Burn.controllers={},Burn.models={},Burn.collections={},Burn.views={},Burn.currentController=null,Burn.resourceHost="",Burn.registerController=function(controller){var name,ref,results,route,routePath;this.router=this.router||new Burn.Router,this.controllers[controller.name]=controller,ref=controller.prototype.routes,results=[];for(route in ref)name=ref[route],routePath=route+"(/)",results.push(Burn.router.registerRoute(routePath,name,controller));return results},Burn.registerView=function(view){return this.views[view.name]=view},Burn.registerModel=function(model){return this.models[model.name]=model},Burn.registerCollection=function(collection){return this.collections[collection.name]=collection},Burn.registerBinder=function(name,binder){return rivets.binders[name]=binder},Burn.registerFilter=function(name,filter){return rivets.filters[name]=filter},Burn.registerComponent=function(name,component){return rivets.components[name]=component},Burn.layout=function(layout){return _.isString(layout)?(this.currentLayout=new Burn.Layout,this.currentLayout.template=layout):layout instanceof Burn.Layout&&(this.currentLayout=layout),this.currentLayout.render(),this.currentLayout},Burn.start=function(){return this._initConfig(),this._initAdapters(),Backbone.history.start()},Burn._initAdapters=function(){return rivets.adapters[":"]=Burn.adapters.BackboneRelational()},Burn._initConfig=function(){var config;return config={prefix:"brn",preloadData:!0,rootInterface:".",templateDelimiters:["{","}"],handler:function(target,event,binding){return binding.model instanceof Burn.Model?this.call(binding.model):this.call(target,event,binding.view.models)}},rivets.configure(config)},Burn}(),self.Burn=Burn,Burn.Cache=function(){function Cache(namespace,persist){this.persist=persist||!1,this.namespace=namespace||""}return Cache.prototype.cache={},Cache.prototype.persist=!1,Cache.prototype.namespace="",Cache.prototype.set=function(key,val){return this.persist?self.localStorage.setItem(this.namespace+":"+key,val):this.cache[key]=val},Cache.prototype.get=function(key){return this.persist?self.localStorage.getItem(this.namespace+":"+key):this.cache[key]},Cache.prototype.remove=function(key){return this.persist?self.localStorage.removeItem(this.namespace+":"+key):delete this.cache[key]},Cache.prototype.clear=function(){var key,ref,results,val;if(this.persist){ref=self.localStorage,results=[];for(key in ref)val=ref[key],0===key.indexOf(this.namespace+":")?results.push(self.localStorage.removeItem(key)):results.push(void 0);return results}return this.cache=[]},Cache}(),Burn.adapters.BackboneRelational=function(){var _factory,_getter,_setter;return _factory=function(action){return function(model,keypath,callback){var eventName,value;if(model instanceof Burn.Model){if(value=model.get(keypath),eventName="*"===keypath?"change":"change:"+keypath,model[action](eventName,callback),value instanceof Burn.Collection)return value[action]("add remove reset sort",callback)}else if(model instanceof Burn.Collection&&"models"===keypath)return model[action]("add remove reset sort",callback)}},_getter=function(obj,keypath){var value;return obj instanceof Burn.Model?(value="*"===keypath?obj.attributes:obj.get(keypath),value instanceof Burn.Collection&&(value=value.models)):obj instanceof Burn.Collection&&(value=obj.models),value},_setter=function(obj,keypath,value){return obj instanceof Burn.Model||obj instanceof Burn.Collection?"*"===keypath?obj.set(value):obj.set(keypath,value):void 0},{observe:_factory("on"),unobserve:_factory("off"),get:_getter,set:_setter}},Burn.Router=function(superClass){function Router(){return Router.__super__.constructor.apply(this,arguments)}return extend(Router,superClass),Router.prototype.registerRoute=function(path,name,controller){var callback;return callback=function(){var arg,ctrl,i,len,match,params,re;if(Burn.currentController instanceof controller?ctrl=Burn.currentController:(Burn.currentController&&Burn.currentController.destroy(),ctrl=Burn.currentController=new controller),params={},arguments.length>0)for(re=/:([a-zA-Z0-9_\-]+)/g,i=0,len=arguments.length;len>i;i++)arg=arguments[i],_.isNull(arg)||(match=re.exec(path),params[match[1]]=arg);return ctrl.runBeforeFilters.apply(ctrl,[params,path,name]).done(function(){return ctrl[name].apply(ctrl,[params]),ctrl.runAfterFilters.apply(ctrl,[params,path,name])}).fail(function(message){return alert(message)})},this.route(path,name,callback)},Router}(Backbone.Router),Burn.FilterChain=function(){function FilterChain(filters){this._runFilter=bind(this._runFilter,this),this._fail=bind(this._fail,this),this._next=bind(this._next,this),this.filters=filters}return FilterChain.prototype.filters=[],FilterChain.prototype.start=function(){return this.q=$.Deferred(),this._next(),this.q.promise()},FilterChain.prototype._next=function(){return this._runFilter(this.filters.shift())},FilterChain.prototype._fail=function(message){return this.q.reject(message)},FilterChain.prototype._runFilter=function(filter){return _.isUndefined(filter)?this.q.resolve():filter.apply(this,[this._next,this._fail])},FilterChain}(),Burn.Controller=function(){function Controller(){}return Controller.prototype.routes={},Controller.prototype.beforeFilters={},Controller.prototype.afterFilters={},Controller.prototype.runBeforeFilters=function(params,path,name){var filters;return filters=this._buildFilterChain(name,this.beforeFilters),new Burn.FilterChain(filters).start()},Controller.prototype.runAfterFilters=function(params,path,name){var filters;return filters=this._buildFilterChain(name,this.afterFilters),new Burn.FilterChain(filters).start()},Controller.prototype.destroy=function(){return this.beforeDestroy(),this.afterDestroy()},Controller.prototype.beforeDestroy=function(){},Controller.prototype.afterDestroy=function(){},Controller.prototype._buildFilterChain=function(name,filters){var action,chain,opts,run;chain=[],console.log("TODO: Change from object to Array to make sure they run in order");for(action in filters)opts=filters[action],run=!1,"all"===opts?run=!0:opts.only&&-1!==opts.only.indexOf(name)?run=!0:opts.except&&-1===opts.except.indexOf(name)&&(run=!0),run&&chain.push(this[action]);return chain},Controller}(),Burn.Model=function(superClass){function Model(){this.on("request",function(){return this.updating=!0}),this.on("sync",function(){return this.updating=!1}),this.on("error",function(){return this.updating=!1}),Model.__super__.constructor.apply(this,arguments)}return extend(Model,superClass),Model.prototype.updating=!1,Model.prototype.url=function(){var _url,id,path;if(!this.resourcePath)throw new Error(this.constructor.name+" must specify a resourcePath");return path=_.isFunction(this.resourcePath)?this.resourcePath():this.resourcePath,id=this.get("id"),_url=Burn.resourceHost+"/"+path,id&&(_url=_url+"/"+id),_url},Model.prototype.update=function(opts){var changed,q;return opts=opts||{},opts.patch=!0,changed=this.changedAttributes(),changed?this.save(changed,opts):(q=$.Deferred(),q.resolve(!1),q)},Model}(Backbone.RelationalModel),Burn.Collection=function(superClass){function Collection(){return Collection.__super__.constructor.apply(this,arguments)}return extend(Collection,superClass),Collection.prototype.url=function(){var path;if(!this.resourcePath)throw new Error(this.constructor.name+" must specify a resourcePath");return path=_.isFunction(this.resourcePath)?this.resourcePath():this.resourcePath,Burn.resourceHost+"/"+path},Collection}(Backbone.Collection),Burn.Template=function(){function Template(templateUrl){this.templateUrl=templateUrl}return Template.caching=!0,Template.qCache=new Burn.Cache("templates-q",!1),Template.tplCache=new Burn.Cache("templates",!0),Template.baseUrl="",Template.prototype.templateUrl="",Template.prototype.templateString="",Template.prototype.load=function(cache){var q;return _.isUndefined(cache)&&(cache=Burn.Template.caching),cache&&Burn.Template.qCache.get(this.templateUrl)?Burn.Template.qCache.get(this.templateUrl):(q=$.Deferred(),Burn.Template.qCache.set(this.templateUrl,q),cache&&Burn.Template.tplCache.get(this.templateUrl)?q.resolve(Burn.Template.tplCache.get(this.templateUrl)):$.get(this.templateUrl).done(function(_this){return function(tpl){return _this.templateString=tpl,Burn.Template.tplCache.set(_this.templateUrl,_this.templateString),q.resolve(_this.templateString)}}(this)).fail(function(){return q.reject()}),q.promise())},Template}(),Burn.Attachment=function(){function Attachment(element){this.el=element,this.$el=$(this.el)}return Attachment.prototype.el=null,Attachment.prototype.$el=null,Attachment.prototype.subviews=[],Attachment.prototype.appendView=function(view){return view.render(),this.$el.append(view.el),this.subviews.push(view)},Attachment.prototype.prependView=function(view){return view.render(),this.$el.append(view.el),this.subviews.push(view)},Attachment.prototype.removeView=function(view){return this.subviews.splice(this.subviews.indexOf(view),1),view.destroy()},Attachment.prototype.destroy=function(){var i,len,ref,view;for(ref=this.subviews,i=0,len=ref.length;len>i;i++)view=ref[i],view.destroy();return this.$el.remove()},Attachment}(),Burn.Layout=function(){function Layout(templateUrl){this.template=templateUrl}return Layout.prototype.template=null,Layout.prototype.attachments={},Layout.prototype.el=null,Layout.prototype.render=function(selector){var q;return selector=selector||"[brn-app]",this.el=$(selector).first(),q=$.Deferred(),new Burn.Template(this.template).load().done(function(_this){return function(tpl){return _this.el.html(tpl),_this._initAttachments(),q.resolve(_this)}}(this)).fail(function(){return q.reject()}),q.promise()},Layout.prototype.destroy=function(){var container,name,ref;ref=this.attachments;for(name in ref)container=ref[name],container.destroy(),delete this.attachments[name],delete this[name];return this.el.remove()},Layout.prototype._initAttachments=function(){return this.el.find("[brn-attach]").each(function(_this){return function(idx,ele){var $ele,name;return $ele=$(ele),name=$ele.attr("brn-attach"),_this.attachments[name]=new Burn.Attachment(ele),_this[name]=_this.attachments[name]}}(this))},Layout}(),Burn.View=function(superClass){function View(opts){var key,ref,val;if(_.isObject(opts)&&opts.properties){ref=opts.properties;for(key in ref)val=ref[key],this[key]=val}View.__super__.constructor.apply(this,arguments)}return extend(View,superClass),View.prototype._binding=null,View.prototype.beforeRender=function(){},View.prototype.afterRender=function(){},View.prototype.beforeDestroy=function(){},View.prototype.afterDestroy=function(){},View.prototype.render=function(){return this.$el.addClass(this.constructor.name),this.beforeRender(),new Burn.Template(this.template).load().then(function(_this){return function(tpl){return _this.$el.html(tpl),_this._binding=rivets.bind(_this.el,_this),_this.afterRender()}}(this)),this.el},View.prototype.destroy=function(){return this._beforeDestroy(),this.parent=null,this._binding.unbind(),delete this._binding,this.remove(),this.afterDestroy()},View}(Backbone.View),IncludeComponent={"static":["view"],template:function(){return""},initialize:function(el,data){return delete data.view,this._view=new Burn.views[this["static"].view]({properties:data}),$(el).html(this._view.render()),this._view}},Burn.registerComponent("include",IncludeComponent)}).call(this);